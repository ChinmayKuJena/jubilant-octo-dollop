<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebSocket Chat</title>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <style>
      #messages {
        height: 200px;
        overflow-y: scroll;
        border: 1px solid #ccc;
        margin-bottom: 10px;
      }

      /* Toast styling */
      .toast {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: #333;
        color: #fff;
        padding: 10px 20px;
        border-radius: 5px;
        display: none;
        opacity: 0;
        transition: opacity 0.5s;
      }

      .toast.show {
        display: block;
        opacity: 1;
      }
    </style>
  </head>
  <body>
    <h1>Chat Application</h1>

    <div id="messages"></div>

    <input type="text" id="messageInput" placeholder="Type a message..." />
    <button id="sendMessage">Send</button>

    <!-- Toast container -->
    <div class="toast" id="toast"></div>

    <script>

      //const BASE_URL = 'https://13.126.46.170:443'; // Define your base URL here
     const BASE_URL = 'https://localhost:443'; // Define your base URL here

      // Get the token from local storage
      let token = localStorage.getItem('token');
      const roomId = 'room123'; // Generate or get the room ID dynamically

      if (!token) {
        showToast('You are not authenticated. Redirecting to login.', 'error');
        setTimeout(() => {
          window.location.href = 'login.html'; // Redirect to the login page
        }, 2000);
      } else {
        // Add 'Bearer' prefix if not already included
        if (!token.startsWith('Bearer ')) {
          token = `Bearer ${token}`;
        }
      }

      // Connect to the WebSocket server with the token
      const socket = io(`${BASE_URL}/chat`, {
        auth: { token },
        query: { roomId }, // Pass room ID during connection
      });

      // Handle connection errors
      socket.on('connect_error', (err) => {
        console.error('Connection error:', err.message);
        showToast('Authentication failed. Redirecting to login.', 'error');
        setTimeout(() => {
          window.location.href = 'login.html'; // Redirect to the login page
        }, 2000);
      });

      // Subscribe to chat messages
      socket.emit('subscribe_to_chat', roomId);

      // Listen for incoming messages
      socket.on('receive_message', (message) => {
        const messagesDiv = document.getElementById('messages');
        const messageElement = document.createElement('div');
        messageElement.textContent = message;
        messagesDiv.appendChild(messageElement);
        messagesDiv.scrollTop = messagesDiv.scrollHeight; // Scroll to bottom
      });

      // Send a message to the server
      document.getElementById('sendMessage').addEventListener('click', () => {
        const message = document.getElementById('messageInput').value;
        if (message) {
          socket.emit('send_message', { roomId, message });
          document.getElementById('messageInput').value = ''; // Clear input field
        }
      });

      // Function to show toast messages
      function showToast(message, type) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = `toast ${type === 'error' ? 'error' : 'success'}`;
        toast.classList.add('show');
        setTimeout(() => {
          toast.classList.remove('show');
        }, 3000);
      }
    </script>
  </body>
</html>
